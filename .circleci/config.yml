version: 2.1

jobs:
  lint:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install shellcheck
          command: |
            sudo apt-get update -qq
            sudo apt-get install -y shellcheck
      - run:
          name: shellcheck
          command: shellcheck bin/stream-transcribe bin/gc
      - run:
          name: Install shfmt
          command: |
            curl -sS https://webi.sh/shfmt | sh
            echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$BASH_ENV"
      - run:
          name: shfmt
          command: shfmt -d -i 2 -ci bin/stream-transcribe bin/gc

  test:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install bats-core
          command: |
            sudo apt-get update -qq
            sudo apt-get install -y bats
      - run:
          name: Create stubs for ffmpeg and whisper-cli
          command: |
            mkdir -p "$HOME/.local/bin"

            cat > "$HOME/.local/bin/ffmpeg" <<'STUB'
            #!/bin/bash
            if [[ "$*" == *"list_devices"* ]]; then
              echo "[AVFoundation indev @ 0x1] [0] Built-in Microphone"
              echo "[AVFoundation indev @ 0x1] [1] BlackHole 2ch"
              exit 1
            fi
            for arg in "$@"; do
              if [[ "$arg" == *.wav ]]; then
                dd if=/dev/zero bs=1 count=100 of="$arg" 2>/dev/null
              fi
            done
            exit 0
            STUB
            chmod +x "$HOME/.local/bin/ffmpeg"

            cat > "$HOME/.local/bin/whisper-cli" <<'STUB'
            #!/bin/bash
            of_next=false; outfile=""
            for arg in "$@"; do
              if $of_next; then outfile="$arg"; of_next=false; fi
              [[ "$arg" == "-of" ]] && of_next=true
            done
            [[ -n "$outfile" ]] && echo "stub transcript" > "${outfile}.txt"
            exit 0
            STUB
            chmod +x "$HOME/.local/bin/whisper-cli"

            echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$BASH_ENV"
      - run:
          name: Run bats tests
          command: bats tests/

workflows:
  ci:
    jobs:
      - lint
      - test
